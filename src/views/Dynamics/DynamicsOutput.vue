<style scoped>
* >>> .v-stepper__step .mdi::before,
* >>> .v-stepper__step .v-stepper__step__step {
  color: #252525 !important;
  padding: 20px;
}
* >>> .v-stepper__content {
  margin: -6px -36px -16px 43px !important;
}
</style>
<template>
  <v-container fluid class="d-flex flex-column" style="overflow-y: auto;">
    <v-row no-gutters>
      <v-card class="flex-grow-1 mb-4" height="500">
        <!-- <dynamic-chart>
          <template v-slot:data>
            <dynamic-chart-plot></dynamic-chart-plot>
          </template>
        </dynamic-chart> -->

        <pad-zoom-view>
          <svg
            xmlns:dc="http://purl.org/dc/elements/1.1/"
            xmlns:cc="http://web.resource.org/cc/"
            xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
            xmlns:svg="http://www.w3.org/2000/svg"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
            width="600"
            height="600"
            id="svg2"
            sodipodi:version="0.32"
            inkscape:version="0.44"
            version="1.0"
            sodipodi:docbase="C:\Documents and Settings\Elembis\My Documents\Images\Shartak\Shartak.com"
            sodipodi:docname="bananas3.svg"
            inkscape:export-filename="C:\Documents and Settings\Elembis\My Documents\Images\Shartak\Shartak.com\banana.png"
            inkscape:export-xdpi="25.797226"
            inkscape:export-ydpi="25.797226"
          >
            <defs id="defs4" />
            <sodipodi:namedview
              id="base"
              pagecolor="#ffffff"
              bordercolor="#666666"
              borderopacity="1.0"
              gridtolerance="10000"
              guidetolerance="10"
              objecttolerance="10"
              inkscape:pageopacity="0.0"
              inkscape:pageshadow="2"
              inkscape:zoom="1"
              inkscape:cx="257.85399"
              inkscape:cy="231.60006"
              inkscape:document-units="px"
              inkscape:current-layer="layer1"
              inkscape:window-width="1024"
              inkscape:window-height="721"
              inkscape:window-x="-4"
              inkscape:window-y="-4"
            />
            <metadata id="metadata7">
              <rdf:RDF>
                <cc:Work rdf:about="">
                  <dc:format>image/svg+xml</dc:format>
                  <dc:type
                    rdf:resource="http://purl.org/dc/dcmitype/StillImage"
                  />
                </cc:Work>
              </rdf:RDF>
            </metadata>
            <g
              inkscape:label="Layer 1"
              inkscape:groupmode="layer"
              id="layer1"
              transform="translate(-66.38047,-391.3222)"
            >
              <g
                id="g9893"
                inkscape:transform-center-x="88.0002"
                inkscape:transform-center-y="113.00018"
              >
                <path
                  transform="translate(-17.85713,318.6479)"
                  sodipodi:nodetypes="csccccc"
                  id="path17976"
                  d="M 543,119 C 543,119 547,177 531,189 C 515,201 397,320 397,320 L 419,345 L 562,248 L 573,121 L 543,119 z "
                  style="fill:#ffc701;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
                <path
                  sodipodi:nodetypes="csccccc"
                  id="path18863"
                  d="M 525.14247,437.64826 C 525.14247,437.64826 529.14247,495.64826 513.14247,507.64826 C 497.14247,519.64826 379.14247,638.64826 379.14247,638.64826 L 401.14247,663.64826 L 544.14247,566.64826 L 555.14247,439.64826 L 525.14247,437.64826 z "
                  style="opacity:0.7;fill:black;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
              </g>
              <g id="g2783">
                <path
                  id="path6424"
                  d="M 519.9114,399.65406 L 483.38679,454.45323 C 483.38679,454.45323 454.12626,461.72103 439.29443,470.94146 C 424.46259,480.16189 377.85779,514.19114 274.74769,506.89067 C 171.63759,499.59021 156.32242,477.55739 133.97629,476.75109 C 111.63016,475.9448 77.83775,479.82705 69.64709,486.06507 C 61.45643,492.3031 71.25003,511.09366 71.25003,511.09366 C 71.25003,511.09366 101.21736,578.4951 210.30564,606.14897 C 319.39391,633.80284 448.5453,576.70729 448.5453,576.70729 L 538.74205,411.07361 L 519.9114,399.65406 z "
                  style="fill:#ffc701;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                />
                <path
                  id="path1895"
                  d="M 517.00522,404.00971 L 483.38022,454.44721 C 483.38022,454.44721 454.1183,461.72678 439.28647,470.94721 C 424.45462,480.16764 377.86532,514.18518 274.75522,506.88471 C 171.64512,499.58425 156.3201,477.56601 133.97397,476.75971 C 111.62785,475.95343 77.85213,479.83419 69.66147,486.07221 C 69.2897,486.35536 68.96174,486.67778 68.66147,487.00971 C 87.94596,484.21174 116.37515,484.78053 136.38022,488.41596 C 174.77085,495.39252 209.97775,518.65573 299.50522,516.22846 C 426.73709,512.73998 441.6649,473.10304 459.38022,468.41596 C 484.00837,461.89991 530.48444,452.34626 517.00522,404.00971 z "
                  style="fill:white;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;opacity:0.4"
                />
                <path
                  id="path9086"
                  d="M 106.96213,554.70796 C 128.49383,573.41467 161.44348,593.76255 210.30593,606.14918 C 222.07021,609.13143 234.0755,611.11073 246.11929,612.29962 L 284.83188,604.45269 C 220.5418,614.51673 142.31641,575.18761 106.96213,554.70796 z "
                  style="opacity:0.4;fill:black;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
              </g>
              <g id="g9941">
                <path
                  transform="translate(-17.85713,318.6479)"
                  inkscape:transform-center-y="181"
                  inkscape:transform-center-x="126"
                  sodipodi:nodetypes="cssssssssc"
                  id="path12644"
                  d="M 546,120 C 546,120 567,175 561,189 C 555,203 520,283 455,313 C 390,343 223,339 219,331 C 215,323 219,407 320,438 C 421,469 550.08904,401.09271 573,379 C 602,351 657,279 641,225 C 625,171 613,187 604,172 C 595,157 585,128 585,116 C 585,104 547,120 546,120 z "
                  style="opacity:1;fill:#ffc701;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                />
                <path
                  id="path8981"
                  d="M 533.7244,527.63751 C 518.52971,557.28537 486.49949,608.85189 437.13065,631.63751 C 372.13066,661.63751 205.13065,657.63751 201.13065,649.63751 C 200.13065,647.63751 199.64628,651.40313 201.0369,658.63751 L 201.06815,658.76251 L 203.13065,665.63751 C 203.13064,665.63751 202.9682,665.65254 202.75565,665.73126 C 202.85933,666.09273 202.98841,666.48596 203.0994,666.85626 C 203.2463,667.34553 203.37675,667.82087 203.5369,668.32501 C 203.82494,669.23173 204.17292,670.18568 204.50565,671.13751 C 204.61749,671.45746 204.70108,671.78151 204.81815,672.10626 C 205.04405,672.73471 205.32226,673.36688 205.56815,674.01251 C 205.8517,674.75499 206.10087,675.49879 206.4119,676.26251 C 206.6323,676.80515 206.89597,677.36609 207.13065,677.91876 C 207.44564,678.65842 207.75805,679.38112 208.0994,680.13751 C 208.26157,680.49795 208.4311,680.86725 208.5994,681.23126 C 209.69117,683.59259 210.89044,686.02408 212.25565,688.51251 C 212.29126,688.57728 212.34485,688.63516 212.38065,688.70001 C 212.39669,688.72911 212.39582,688.76464 212.4119,688.79376 C 212.77389,689.44818 213.15496,690.10127 213.5369,690.76251 C 213.57214,690.82361 213.59523,690.88885 213.63065,690.95001 C 214.03425,691.64604 214.45442,692.3411 214.88065,693.04376 C 215.33612,693.79463 215.80496,694.56759 216.2869,695.32501 C 216.29464,695.33717 216.3104,695.34409 216.31815,695.35626 C 216.77977,696.08134 217.23774,696.81355 217.7244,697.54376 C 217.72759,697.54854 217.75246,697.53898 217.75565,697.54376 C 258.55477,715.44577 403.2244,681.10626 468.13065,633.63751 C 513.82083,600.22229 528.80654,553.79612 533.7244,527.63751 z "
                  style="opacity:0.6;fill:black;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                />
                <path
                  id="path17089"
                  d="M 559.79937,430.17885 C 558.18509,430.20703 556.38497,430.42195 554.48687,430.74135 C 560.75792,449.99636 590.83405,543.70808 588.14312,561.6476 C 585.14312,581.6476 553.30943,654.34782 501.14312,685.6476 C 466.14312,706.6476 390.14312,739.6476 363.14312,744.6476 C 346.05557,747.81196 312.61613,752.46521 286.48687,751.11635 C 291.4351,753.10006 296.63167,754.95597 302.14312,756.6476 C 403.14312,787.6476 532.23216,719.74031 555.14312,697.6476 C 584.14312,669.6476 639.14312,597.6476 623.14312,543.6476 C 607.14312,489.6476 595.14312,505.6476 586.14312,490.6476 C 577.14312,475.6476 567.14312,446.6476 567.14312,434.6476 C 567.14312,431.2726 564.14254,430.10304 559.79937,430.17885 z "
                  style="opacity:0.4;fill:black;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
              </g>
              <g id="g9903">
                <path
                  sodipodi:nodetypes="cssccccc"
                  id="path1933"
                  d="M 533.14287,448.6479 C 533.14287,448.6479 514.14287,467.6479 519.14287,485.6479 C 524.14287,503.6479 541.14287,547.6479 478.14287,597.6479 C 415.14287,647.6479 232.14287,734.6479 109.14287,639.6479 C 74.14287,599.6479 94.14287,573.6479 94.14287,573.6479 C 94.14287,573.6479 114.12992,570.75757 122.14287,571.6479 C 132.14287,568.6479 179.14287,571.6479 223.14287,573.6479 C 282.05327,572.49008 443.14287,497.6479 474.14287,468.6479 C 474.14287,468.6479 512.14287,422.6479 513.14287,414.6479 C 514.14287,406.6479 540.14287,430.6479 541.14287,437.6479 C 542.14287,444.6479 533.14287,447.6479 533.14287,448.6479 z "
                  style="fill:#ffc701;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                />
                <path
                  sodipodi:nodetypes="cssccccsscc"
                  id="path7201"
                  d="M 514.60028,413.04467 C 513.79169,413.14037 513.25653,413.63842 513.13153,414.63842 C 512.13153,422.63842 474.13153,468.63841 474.13153,468.63842 C 443.13153,497.63842 282.04191,572.4806 223.13152,573.63842 C 179.13152,571.63842 132.13152,568.63842 122.13152,571.63842 C 114.11858,570.74809 94.13152,573.63842 94.13152,573.63842 C 94.13152,573.63842 93.7656,574.16602 93.22527,575.07592 C 104.18437,578.28284 124.12588,582.75014 156.38152,583.60717 C 230.77215,585.58373 262.00653,581.54467 326.50653,556.41967 C 394.13686,530.0753 484.82418,496.21955 520.38153,415.35717 C 517.97095,413.81698 515.90107,412.89071 514.60028,413.04467 z "
                  style="opacity:0.4;fill:white;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                />
                <path
                  id="path4646"
                  d="M 518.58062,482.8981 C 510.39544,511.03311 477.26645,585.47414 350.14312,628.6481 C 194.69709,681.44109 156.81818,651.08254 106.61187,636.61685 C 107.43132,637.61484 108.2539,638.63184 109.14312,639.6481 C 232.14312,734.6481 415.14312,647.6481 478.14312,597.6481 C 541.14312,547.6481 524.14312,503.6481 519.14312,485.6481 C 518.88851,484.73149 518.71644,483.81726 518.58062,482.8981 z "
                  style="opacity:0.4;fill:black;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
              </g>
              <g id="g9946">
                <path
                  sodipodi:nodetypes="czsssz"
                  id="path23294"
                  d="M 534.47367,391.42537 C 528.72367,389.92537 508.71616,405.72925 509.06846,411.02017 C 509.42029,416.30405 528.53454,433.43637 540.64281,437.57407 C 544.64281,438.57407 566.64281,436.57407 567.64281,432.57407 C 568.64281,428.57407 568.64281,411.57407 564.64281,407.57407 C 560.64281,403.57407 541.16441,393.17078 534.47367,391.42537 z "
                  style="fill:#884a13;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:4;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
                />
                <path
                  sodipodi:nodetypes="czsssz"
                  id="path22407"
                  d="M 534.47374,391.42502 C 528.72374,389.92502 508.71623,405.7289 509.06853,411.01982 C 509.42036,416.3037 528.53461,433.43602 540.64288,437.57372 C 544.64288,438.57372 566.64288,436.57372 567.64288,432.57372 C 568.64288,428.57372 568.64288,411.57372 564.64288,407.57372 C 560.64288,403.57372 541.16448,393.17043 534.47374,391.42502 z "
                  style="fill:#884a13;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
                <path
                  id="path25958"
                  d="M 533.23672,391.3354 C 526.30206,391.85508 508.75019,406.06266 509.08047,411.0229 C 509.222,413.14841 512.41917,417.17996 516.95547,421.5229 C 517.24178,413.18494 521.37892,401.08827 540.67422,393.7729 C 538.17765,392.66554 536.00097,391.82417 534.48672,391.42915 C 534.12734,391.3354 533.69903,391.30075 533.23672,391.3354 z "
                  style="opacity:0.3;fill:white;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
                <path
                  id="path26854"
                  d="M 564.58087,407.52257 C 564.73328,425.7813 549.04695,433.48138 538.20587,436.61632 C 539.04145,436.98636 539.85952,437.31721 540.64337,437.58507 C 544.64338,438.58507 566.64337,436.58507 567.64337,432.58507 C 568.64338,428.58507 568.64337,411.58507 564.64337,407.58507 C 564.62587,407.56758 564.59896,407.54031 564.58087,407.52257 z "
                  style="opacity:0.4;fill:black;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                />
              </g>
            </g>
          </svg>
        </pad-zoom-view>
      </v-card>
    </v-row>

    <v-col class="flex-grow-0 pa-0 mb-3">
      <v-card flat class="flex-grow-1">
        <v-card-title>Dynamics outputs</v-card-title>
        <v-card-subtitle>
          This tool allows you to upload dynamics simulation files from Witness,
          PlantSimulation or Sympy. These files are then used for example by the
          routing analysis tool.
        </v-card-subtitle>
      </v-card>
    </v-col>
    <v-card class="mx-auto" style="max-width: 1000px;">
      <!-- Header -->
      <v-sheet
        class="pa-6 text-h5"
        :color="$vuetify.theme.dark ? null : 'rgba(0, 0, 0, 0.06)'"
      >
        Current file :
        <span class="primary--text">{{ filename ? filename : 'None' }}</span>
      </v-sheet>

      <v-stepper v-model="step" vertical>
        <!-- Step 1 : import file -->
        <v-stepper-step
          :complete="step > 1"
          step="1"
          editable
          edit-icon="mdi-file"
        >
          Import
          <small class="pt-1">Open your file</small>
        </v-stepper-step>

        <v-stepper-content step="1" editable>
          <v-row no-gutters style="gap: 20px">
            <input
              ref="fileInput"
              type="file"
              id="input"
              style="display: none;"
              accept=".xlsx, .xls, .csv"
              @change="onInputFileChange($event)"
            />
            <v-btn
              outlined
              color="primary"
              class="black--text flex-grow-1"
              @click="
                $refs.fileInput.value = null
                resetInputFile()
                $refs.fileInput.click()
              "
            >
              Open local file
            </v-btn>
            <v-btn color="primary black--text flex-grow-1">
              Open from cloud
            </v-btn>
          </v-row>
        </v-stepper-content>

        <!-- Step 2 : Select sheets -->
        <v-stepper-step
          :complete="step > 2"
          step="2"
          :editable="filename !== ''"
          edit-icon="mdi-table-large"
        >
          Select data sheet
          <small class="pt-1">Select your data by sheet name</small>
        </v-stepper-step>

        <v-stepper-content step="2">
          <v-col>
            <v-select
              :value="selectedSheets.stocks"
              :items="sheetsNames"
              label="Stock sheet"
            ></v-select>
            <v-select
              :value="selectedSheets.utilizations"
              :items="sheetsNames"
              label="Utilization sheet"
            ></v-select>
            <v-select
              :value="selectedSheets.transports"
              :items="sheetsNames"
              label="Transport sheet"
            ></v-select>
          </v-col>
          <v-btn color="primary" class="black--text" @click="step = 3">
            Continue
          </v-btn>
          <v-btn text @click="step = 2">
            Cancel
          </v-btn>
        </v-stepper-content>

        <!-- Step 3 : Show data content -->
        <v-stepper-step
          :complete="step > 2"
          step="3"
          :editable="
            selectedSheets.stocks !== '' &&
              selectedSheets.utilizations !== '' &&
              selectedSheets.transports !== ''
          "
          edit-icon="mdi-eye"
        >
          Show data
          <small class="pt-1">
            Show data content
          </small>
        </v-stepper-step>

        <v-stepper-content step="3">
          <v-col class="pa-0">
            <v-card
              v-for="(listName, index) in Object.keys(dataLists)"
              :key="index"
              class="mb-6 mr-6"
            >
              <v-card-title class="text-h6 primary black--text py-0 px-2"
                >Data : {{ listName }}
              </v-card-title>
              <v-card-text class="pa-0">
                <v-data-table
                  :style="{
                    backgroundColor: $vuetify.theme.dark
                      ? ''
                      : 'rgba(0, 0, 0, 0.04)'
                  }"
                  dense
                  :items-per-page="5"
                  :headers="
                    Object.keys(dataLists[listName][0] || {}).map(label => {
                      return {
                        text: label,
                        align: 'start',
                        sortable: true,
                        value: label
                      }
                    })
                  "
                  :items="
                    dataLists[listName].map(item => {
                      Object.keys(item)
                        .filter(key => typeof item[key] === 'number')
                        .forEach(
                          key =>
                            (item[key] = Math.round(item[key] * 10000) / 10000)
                        )
                      return item
                    })
                  "
                  class="elevation-1 mx-0 mb-6"
                  :footer-props="{
                    'items-per-page-options': [5, 10, 15]
                  }"
                >
                </v-data-table>
              </v-card-text>
            </v-card>
          </v-col>
          <v-btn color="primary" class="black--text" @click="step = 4">
            Continue
          </v-btn>
          <v-btn text @click="step = 2">
            Cancel
          </v-btn>
        </v-stepper-content>

        <!-- Step 4 : Charts -->
        <v-stepper-step
          :complete="step > 4"
          step="4"
          :editable="
            selectedSheets.stocks !== '' &&
              selectedSheets.utilizations !== '' &&
              selectedSheets.transports !== ''
          "
        >
          Graphics
          <small class="pt-1"
            >Display and analyse data from graphical visualisations</small
          >
        </v-stepper-step>

        <v-stepper-content step="4">
          <v-btn text>
            Cancel
          </v-btn>
        </v-stepper-content>
      </v-stepper>
    </v-card>
  </v-container>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator'
import * as XLSX from 'ts-xlsx'
import DynamicChart from '@/components/dynamicChart/DynamicChart.vue'
import DynamicChartPlot from '@/components/dynamicChart/DynamicChartPlot.vue'
import PadZoomView from '@/components/dynamicChart/PadZoomView.vue'

class StockItem {
  time = 0
  resId = 0
  resName = ''
  value = 0
  constructor (row: (string | number)[]) {
    this.time = row[0] as number
    this.resId = row[1] as number
    this.resName = row[2] as string
    this.value = row[3] as number
  }
}

class UtilizationItem {
  resName = ''
  work = 0
  setup = 0
  block = 0
  wait = 0
  fail = 0
  constructor (row: (string | number)[]) {
    this.resName = row[0] as string
    this.work = row[1] as number
    this.setup = row[2] as number
    this.block = row[3] as number
    this.wait = row[4] as number
    this.fail = row[5] as number
  }
}

class TransportItem {
  amount = 0
  time = 0
  constructor (row: (string | number)[]) {
    this.amount = row[0] as number
    this.time = row[1] as number
  }
}

@Component({
  name: 'DynamicsOutput',
  components: {
    DynamicChart,
    DynamicChartPlot,
    PadZoomView
  }
})
// @vuese
// @group VIEWS
export default class DynamicsOutput extends Vue {
  step = 1
  filename = ''
  sheetsNames: string[] = []
  selectedSheets = {
    stocks: '',
    utilizations: '',
    transports: ''
  }

  dataLists: {
    stocks: StockItem[]
    utilizations: UtilizationItem[]
    transports: TransportItem[]
  } = {
    stocks: [],
    utilizations: [],
    transports: []
  }

  resetInputFile (): void {
    this.filename = ''
    this.sheetsNames = []
    this.selectedSheets = {
      stocks: '',
      utilizations: '',
      transports: ''
    }
  }

  onInputFileChange (event: Event): void {
    const input = event.target as HTMLInputElement
    if (!input.files) {
      return
    }
    const file = [...input.files].pop()
    if (!file) {
      this.filename = ''
      return
    }

    // Read file
    const fileReader = new FileReader()

    // Load XLSX
    fileReader.onload = event => {
      const data = event.target?.result
      this.filename = file.name
      let workbook = null
      try {
        workbook = XLSX.read(data, {
          type: 'binary'
        })
      } catch (error) {
        this.$root.$emit('bottom-message', 'Cannot parse data file.')
        console.error('error', error)
        return
      }

      // Get all sheets name and set default sheets by names
      this.step = 2
      this.getDataSheets(workbook)
      this.computeCharts(workbook)
    }

    // Load error
    fileReader.onerror = error => {
      console.error(error)
      this.$root.$emit('bottom-message', 'Cannot read this file.')
      this.filename = ''
    }

    // Start file reading
    fileReader.readAsBinaryString(file)
  }

  computeCharts (workbook: XLSX.IWorkBook): void {
    // Check sheets names
    const stock = this.selectedSheets.stocks
    const utilization = this.selectedSheets.utilizations
    const transport = this.selectedSheets.transports
    if ([stock, utilization, transport].some(sheetName => !sheetName)) {
      return
    }

    // Store each values, slice(1) is to remove headers
    this.dataLists.stocks = this.sheetToArray(workbook.Sheets[stock])
      .slice(1)
      .map(row => new StockItem(row))

    this.dataLists.utilizations = this.sheetToArray(
      workbook.Sheets[utilization]
    )
      .slice(1)
      .map(row => new UtilizationItem(row))

    this.dataLists.transports = this.sheetToArray(workbook.Sheets[transport])
      .slice(1)
      .map(row => new TransportItem(row))

    console.log(this.dataLists)
  }

  sheetToArray (sheet: XLSX.IWorkSheet): (string | number)[][] {
    const sheetArray: (string | number)[][] = [[]]
    Object.keys(sheet).map(cell => {
      const cellData = XLSX.utils.decode_cell(cell)
      const coordinate = { x: cellData.c, y: cellData.r }
      if (coordinate) {
        if (sheetArray[coordinate.y] === undefined) {
          sheetArray[coordinate.y] = []
        }
        sheetArray[coordinate.y][coordinate.x] = sheet[cell].v
      }
    })
    return sheetArray
  }

  getDataSheets (workbook: XLSX.IWorkBook): void {
    this.sheetsNames = workbook.SheetNames
    this.sheetsNames.forEach(sheetName => {
      const name = sheetName
        .toLowerCase()
        .replace(/\s/g, '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')

      // Search stock sheet
      if (
        !this.selectedSheets.stocks &&
        [
          'stock',
          'stockpile',
          'reserve',
          'inventaire',
          'approvisionnement',
          'provision',
          'marchandise',
          'lager',
          'bestand',
          'vorrat'
        ].some(searchName => name.includes(searchName))
      ) {
        this.selectedSheets.stocks = sheetName
        return
      }

      // Search utilization sheet
      if (
        !this.selectedSheets.utilizations &&
        [
          'utilization',
          'use',
          'utilisation',
          'usage',
          'nutzung',
          'verwendung',
          'gebrauch',
          'benutzung'
        ].some(searchName => name.includes(searchName))
      ) {
        this.selectedSheets.utilizations = sheetName
        return
      }

      // Search transport sheet
      if (
        !this.selectedSheets.transports &&
        [
          'transport',
          'transportation',
          'beforderung',
          'verkehr'
        ].some(searchName => name.includes(searchName))
      ) {
        this.selectedSheets.transports = sheetName
      }
    })
  }
}
</script>
